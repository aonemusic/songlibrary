<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A ONE MUSIC - LIVE EDITION</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        :root { --primary: #1DB954; --bg: #0b0b0d; --card: #18181b; --text: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; position: sticky; top: 0; background: rgba(11, 11, 13, 0.95); backdrop-filter: blur(10px); z-index: 1000; border-bottom: 1px solid #27272a; }
        .user-avatar { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; object-fit: cover; }
        .live-badge { background: #ff0000; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.6em; font-weight: bold; vertical-align: middle; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .container { max-width: 500px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
        .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 15px; border: 1px solid #27272a; width: 100%; box-sizing: border-box; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #27272a; color: white; outline: none; box-sizing: border-box; }
        .btn { background: var(--primary); color: black; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }

        /* Track List */
        .track-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .track-item:hover { background: #27272a; }
        .track-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }

        /* Full Screen Player */
        .full-player { position: fixed; inset: 0; background: linear-gradient(to bottom, #2a2a2a, #0b0b0d); z-index: 5000; display: none; flex-direction: column; padding: 30px; }
        .player-controls { display: flex; justify-content: space-around; align-items: center; width: 100%; margin-top: 30px; }
        .play-btn-large { font-size: 4em !important; color: var(--primary); }

        /* Like & View Stats in Player */
        .stat-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 0 5px; }
        .like-btn { font-size: 1.5em; cursor: pointer; transition: 0.2s; }
        .view-count { font-size: 0.9em; color: #b3b3b3; display: flex; align-items: center; gap: 5px; }

        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: none; flex-direction: column; overflow-y: auto; }
        .close-btn { font-size: 1.5em; cursor: pointer; color: #888; padding: 20px; }
        .verified { color: #1d9bf0; margin-left: 5px; font-size: 0.8em; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <img id="my-avatar" class="user-avatar" src="" onclick="openProfile('self')">
        <h3 style="margin:0; color: var(--primary);">A ONE</h3>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="background: #1a1a1a; padding: 5px 10px; border-radius: 20px; border: 1px solid #333;">
                <span class="live-badge">LIVE</span>
                <span id="total-live-views" style="font-size: 0.85em; font-weight: bold;">0</span>
            </div>
            <i class="fas fa-cog" style="font-size: 1.3em; cursor:pointer; color: #888;" onclick="toggleUI('settings-ui', true)"></i>
        </div>
    </div>

    <div class="container">
        <div id="auth-box" class="card">
            <h2 style="text-align: center;">Join A ONE</h2>
            <input type="text" id="a-name" placeholder="Name">
            <input type="email" id="a-email" placeholder="Email">
            <input type="password" id="a-pass" placeholder="Password">
            <button class="btn" onclick="authAction()">Continue</button>
        </div>

        <div id="app-box" class="hidden">
            <input type="text" id="search" placeholder="Search music..." oninput="filter()">
            <div id="track-list"></div>
        </div>
    </div>

    <div id="full-player-ui" class="full-player">
        <i class="fas fa-chevron-down" style="font-size: 1.5em; cursor: pointer;" onclick="toggleUI('full-player-ui', false)"></i>
        
        <div style="text-align: center; margin-top: 30px;">
            <img id="fp-img" style="width: 260px; height: 260px; border-radius: 15px; object-fit: cover; box-shadow: 0 15px 35px rgba(0,0,0,0.5);">
            <h2 id="fp-title" style="margin: 20px 0 5px 0;"></h2>
            <p id="fp-art" style="color: #b3b3b3;"></p>
        </div>

        <div class="stat-bar">
            <div class="view-count">
                <i class="far fa-eye"></i> <span id="fp-views">0</span> Views
            </div>
            <i class="fas fa-heart like-btn" id="fp-like-btn" onclick="handleLike()"></i>
        </div>

        <div style="margin-top: 20px;">
            <input type="range" id="fp-seek" value="0" style="width: 100%; accent-color: var(--primary);">
            <div style="display: flex; justify-content: space-between; font-size: 0.75em; color: #888; margin-top: 5px;">
                <span id="fp-cur">0:00</span>
                <span id="fp-dur">0:00</span>
            </div>
        </div>

        <div class="player-controls">
            <i class="fas fa-step-backward" style="color:#888;"></i>
            <i class="fas fa-play-circle play-btn-large" id="fp-play" onclick="togglePlay()"></i>
            <i class="fas fa-step-forward" style="color:#888;"></i>
        </div>

        <div class="card" style="margin-top: 30px; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px;">
            <div style="display: flex; align-items: center; gap: 10px; cursor:pointer;" onclick="openProfile(viewUid)">
                <img id="fp-up-img" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                <div>
                    <b id="fp-up-name" style="font-size:0.9em;"></b>
                    <p id="fp-up-fol" style="font-size: 0.7em; color: #888; margin: 0;"></p>
                </div>
            </div>
            <button id="fp-fol-btn" class="btn" style="width: 85px; padding: 6px; font-size: 0.75em; border-radius: 20px;" onclick="handleFollow()">Follow</button>
        </div>
    </div>

    <div id="settings-ui" class="overlay">
        <i class="fas fa-times close-btn" onclick="toggleUI('settings-ui', false)"></i>
        <div class="container">
            <h2 style="margin-bottom: 20px;">Settings</h2>
            <div class="card">
                <h4 style="margin-top:0; color: var(--primary);">Upload Song</h4>
                <input type="text" id="s-title" placeholder="Song Title">
                <input type="text" id="s-artist" placeholder="Artist Name">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn" style="background: #333; color: white;" onclick="pick('l')">Logo</button>
                    <button class="btn" style="background: #333; color: white;" onclick="pick('s')">Audio</button>
                </div>
                <button id="pub-btn" class="btn" style="margin-top: 15px; display: none;" onclick="publish()">Publish</button>
            </div>
            <button class="btn" style="background: #f43f5e; color: white;" onclick="logout()">Logout Account</button>
        </div>
    </div>

    <div id="profile-ui" class="overlay">
        <i class="fas fa-arrow-left close-btn" onclick="toggleUI('profile-ui', false)"></i>
        <div style="text-align: center;">
            <div style="position: relative; display: inline-block;">
                <img id="view-p-img" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
                <div id="edit-pic-icon" onclick="updatePic()" style="position: absolute; bottom: 0; right: 0; background: var(--primary); padding: 6px; border-radius: 50%; display: none; cursor:pointer;"><i class="fas fa-camera" style="color: black; font-size: 0.7em;"></i></div>
            </div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px;">
                <h2 id="view-p-name" style="margin: 0;"></h2>
                <i id="edit-name-icon" class="fas fa-pen" style="color: #888; cursor:pointer; display: none; font-size: 0.7em;" onclick="editUsername()"></i>
            </div>
            <p id="view-p-fol" style="color: #888; font-size: 0.9em;"></p>
            <button id="main-fol-btn" class="btn" style="width: 120px; border-radius: 20px; display: none; margin: 10px auto;" onclick="handleFollow()">Follow</button>
        </div>
        <div id="user-songs" style="margin-top: 20px;"></div>
    </div>

    <audio id="audio-player"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, get, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAthFMO8zGT5BtiOkh4zkc71jL06LR_F9c",
            authDomain: "a-one-chat-19ad6.firebaseapp.com",
            databaseURL: "https://a-one-chat-19ad6-default-rtdb.firebaseio.com",
            projectId: "a-one-chat-19ad6",
            storageBucket: "a-one-chat-19ad6.firebasestorage.app",
            messagingSenderId: "691783470864",
            appId: "1:691783470864:web:0b119fcddf984af66e5f95"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        let tempL = "", tempS = "", songs = [], curId = null, viewUid = null;
        const audio = document.getElementById('audio-player');
        const blueTickHtml = `<i class="fas fa-check-circle verified"></i>`;

        window.toggleUI = (id, show) => document.getElementById(id).style.display = show ? 'flex' : 'none';

        // AUTH
        window.authAction = async () => {
            const e = document.getElementById('a-email').value, p = document.getElementById('a-pass').value, n = document.getElementById('a-name').value;
            try { 
                let c = await createUserWithEmailAndPassword(auth, e, p);
                await updateProfile(c.user, { displayName: n, photoURL: "https://cdn-icons-png.flaticon.com/512/149/149071.png" });
                location.reload();
            } catch { signInWithEmailAndPassword(auth, e, p).catch(err => alert(err.message)); }
        };

        onAuthStateChanged(auth, u => {
            if(u){
                document.getElementById('auth-box').classList.add('hidden');
                document.getElementById('app-box').classList.remove('hidden');
                document.getElementById('my-avatar').src = u.photoURL;
                load();
            }
        });

        // LIVE VIEW COUNTER (TOP RIGHT)
        function updateGlobalViews(allSongs) {
            let total = 0;
            allSongs.forEach(s => total += (s.views || 0));
            document.getElementById('total-live-views').innerText = total.toLocaleString();
        }

        // LOAD SONGS
        function load() {
            onValue(ref(rtdb, 'songs'), snap => {
                songs = []; snap.forEach(c => songs.push({id: c.key, ...c.val()}));
                filter();
                updateGlobalViews(songs);
            });
        }

        window.filter = () => {
            const list = document.getElementById('track-list'); list.innerHTML = "";
            const q = document.getElementById('search').value.toLowerCase();
            songs.filter(s => s.title.toLowerCase().includes(q)).forEach(s => {
                const isVerified = s.views >= 1000;
                list.innerHTML += `<div class="track-item" onclick="playSong('${s.id}')"><img src="${s.logo}"><div><b>${s.title}</b><p style="margin:0;font-size:0.8em;color:#888;">${s.artist} ${isVerified ? blueTickHtml : ""}</p></div></div>`;
            });
        };

        // PLAY LOGIC
        window.playSong = (id) => {
            curId = id;
            const s = songs.find(x => x.id === id);
            const isVerified = s.views >= 1000;

            document.getElementById('fp-title').innerText = s.title;
            document.getElementById('fp-art').innerText = s.artist;
            document.getElementById('fp-img').src = s.logo;
            document.getElementById('fp-up-name').innerHTML = s.up + (isVerified ? " " + blueTickHtml : "");
            document.getElementById('fp-up-img').src = s.up_p;
            
            // Real-time View Sync for Player
            onValue(ref(rtdb, `songs/${id}/views`), snap => {
                document.getElementById('fp-views').innerText = (snap.val() || 0).toLocaleString();
            });

            // Real-time Like Sync
            onValue(ref(rtdb, `songs/${id}/likes/${auth.currentUser.uid}`), snap => {
                const liked = snap.exists();
                document.getElementById('fp-like-btn').style.color = liked ? "var(--primary)" : "white";
                document.getElementById('fp-like-btn').className = liked ? "fas fa-heart like-btn" : "far fa-heart like-btn";
            });

            viewUid = s.uid;
            updateFollowInfo();
            
            if(audio.src !== s.url) { 
                audio.src = s.url; audio.play(); 
                runTransaction(ref(rtdb, `songs/${id}/views`), v => (v || 0) + 1);
            }
            toggleUI('full-player-ui', true);
            document.getElementById('fp-play').className = "fas fa-pause-circle play-btn-large";
        };

        window.handleLike = () => {
            const lRef = ref(rtdb, `songs/${curId}/likes/${auth.currentUser.uid}`);
            get(lRef).then(s => s.exists() ? remove(lRef) : set(lRef, true));
        };

        window.togglePlay = () => {
            if(audio.paused) { audio.play(); document.getElementById('fp-play').className="fas fa-pause-circle play-btn-large"; }
            else { audio.pause(); document.getElementById('fp-play').className="fas fa-play-circle play-btn-large"; }
        };

        // AUDIO SEEK LOGIC
        const sb = document.getElementById('fp-seek');
        audio.ontimeupdate = () => {
            sb.max = audio.duration || 0; sb.value = audio.currentTime;
            document.getElementById('fp-cur').innerText = fmt(audio.currentTime);
            document.getElementById('fp-dur').innerText = fmt(audio.duration || 0);
        };
        sb.oninput = () => audio.currentTime = sb.value;
        function fmt(s) { let m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${sec<10?'0'+sec:sec}`; }

        // REMAINING LOGIC (UPLOAD, PROFILE, ETC)
        window.pick = (m) => {
            cloudinary.openUploadWidget({cloudName:"dcsczlahu", uploadPreset:"ml_default", resourceType: m==='s'?'video':'image'}, (err, res) => {
                if(!err && res.event === "success"){
                    if(m==='l') tempL = res.info.secure_url;
                    if(m==='s') { tempS = res.info.secure_url; document.getElementById('pub-btn').style.display='block'; }
                }
            });
        };

        window.publish = () => {
            push(ref(rtdb, 'songs'), { title: document.getElementById('s-title').value, artist: document.getElementById('s-artist').value, logo: tempL, url: tempS, uid: auth.currentUser.uid, up: auth.currentUser.displayName, up_p: auth.currentUser.photoURL, views: 0 });
            toggleUI('settings-ui', false);
        };

        window.openProfile = (uid) => {
            viewUid = uid === 'self' ? auth.currentUser.uid : uid;
            const isMe = viewUid === auth.currentUser.uid;
            const hasVerifiedSong = songs.some(s => s.uid === viewUid && s.views >= 1000);
            onValue(ref(rtdb, `users/${viewUid}`), snap => {
                const uData = snap.val() || songs.find(s => s.uid === viewUid);
                document.getElementById('view-p-name').innerHTML = (uData?.up || auth.currentUser.displayName) + (hasVerifiedSong ? " " + blueTickHtml : "");
                document.getElementById('view-p-img').src = uData?.up_p || auth.currentUser.photoURL;
            });
            document.getElementById('edit-pic-icon').style.display = isMe ? 'block' : 'none';
            document.getElementById('edit-name-icon').style.display = isMe ? 'block' : 'none';
            document.getElementById('main-fol-btn').style.display = isMe ? 'none' : 'block';
            updateFollowInfo();
            const uList = document.getElementById('user-songs'); uList.innerHTML = "<h4 style='margin-left:15px;'>Tracks</h4>";
            songs.filter(s => s.uid === viewUid).forEach(s => {
                uList.innerHTML += `<div class="track-item" onclick="playSong('${s.id}')"><img src="${s.logo}"><b>${s.title}</b></div>`;
            });
            toggleUI('profile-ui', true);
        };

        function updateFollowInfo() {
            onValue(ref(rtdb, `users/${viewUid}/followers`), snap => {
                const count = snap.size || 0;
                document.getElementById('fp-up-fol').innerText = count + " Followers";
                document.getElementById('view-p-fol').innerText = count + " Followers";
                const isFollowing = snap.hasChild(auth.currentUser.uid);
                document.getElementById('fp-fol-btn').innerText = isFollowing ? "Following" : "Follow";
                document.getElementById('main-fol-btn').innerText = isFollowing ? "Following" : "Follow";
            });
        }

        window.handleFollow = () => {
            const fRef = ref(rtdb, `users/${viewUid}/followers/${auth.currentUser.uid}`);
            get(fRef).then(s => s.exists() ? remove(fRef) : set(fRef, true));
        };

        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
