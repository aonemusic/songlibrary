<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A ONE MUSIC - Advanced</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <style>
        :root { --primary: #007bff; --glass: rgba(255, 255, 255, 0.1); --border: rgba(255, 255, 255, 0.2); --success: #28a745; }
        body { font-family: 'Poppins', sans-serif; background: #0f0f12; color: white; margin: 0; padding: 20px; text-align: center; }
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--border); padding: 20px; border-radius: 15px; max-width: 400px; margin: 0 auto 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; outline: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .fab-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--success); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #upload-form { display: none; margin-top: 15px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .box { background: var(--glass); padding: 20px; border-radius: 15px; width: 350px; border: 1px solid var(--border); }
        .track-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; position: relative; }
        .track-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .stats { font-size: 0.75em; color: #aaa; display: flex; gap: 10px; margin-top: 5px; }
        .like-btn { cursor: pointer; transition: 0.2s; }
        .like-btn.liked { color: #ff4d4d; }
        .hidden { display: none; }
        .upload-info { font-size: 0.8em; color: var(--success); margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <h1>A ONE MUSIC âœ“</h1>

    <div id="auth-section" class="card">
        <h3>Login / Sign Up</h3>
        <input type="text" id="auth-username" placeholder="Your Name">
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-password" placeholder="Password">
        <button class="btn" onclick="handleAuth()">Continue</button>
    </div>

    <div id="app-content" class="hidden">
        <div class="card" style="display:flex; justify-content: space-between; align-items: center; padding: 10px 20px;">
            <b id="user-welcome"></b>
            <button onclick="logout()" style="background:none; border:none; color:#ff4d4d; cursor:pointer;">Logout</button>
        </div>

        <div style="margin-bottom: 30px;">
            <button class="fab-btn" id="toggle-upload" onclick="toggleUploadForm()"><i class="fas fa-plus"></i></button>
            
            <div id="upload-form" class="card">
                <h4>Upload Song</h4>
                <input type="text" id="song-name" placeholder="Song Name">
                <input type="text" id="singer-name" placeholder="Singer Name">
                <input type="text" id="song-logo" placeholder="Logo URL (or keep blank)">
                
                <p style="font-size: 0.8em; color: #bbb; margin: 10px 0;">Select your audio file below:</p>
                <button class="btn" style="background: #555;" onclick="triggerCloudinary()">
                    <i class="fas fa-file-audio"></i> Choose Music File
                </button>
                <div id="upload-status" class="upload-info">File ready for upload!</div>
                
                <button id="final-upload-btn" class="btn" style="background:var(--success); margin-top: 15px; display: none;" onclick="saveSongData()">
                    Confirm & Publish
                </button>
            </div>
        </div>

        <div class="container">
            <div class="box">
                <h3>Global Playlist ðŸ’¿</h3>
                <div id="track-list"></div>
            </div>

            <div class="box">
                <img id="player-img" src="songlogo.jpg" style="width: 100%; border-radius: 15px; max-height: 250px; object-fit: cover;">
                <h4 id="player-title" style="margin: 15px 0 5px;">Select a song</h4>
                <p id="player-artist" style="color: #bbb; font-size: 0.85em; margin-bottom: 15px;"></p>
                <audio id="audio-player" controls style="width: 100%;"></audio>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAthFMO8zGT5BtiOkh4zkc71jL06LR_F9c",
            authDomain: "a-one-chat-19ad6.firebaseapp.com",
            databaseURL: "https://a-one-chat-19ad6-default-rtdb.firebaseio.com",
            projectId: "a-one-chat-19ad6",
            storageBucket: "a-one-chat-19ad6.firebasestorage.app",
            messagingSenderId: "691783470864",
            appId: "1:691783470864:web:0b119fcddf984af66e5f95"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        let tempUploadUrl = "";

        // Auth
        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-username').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(cred.user, { displayName: name });
            } catch (e) {
                signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-welcome').innerText = "Hi, " + user.displayName;
                loadSongs();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        window.toggleUploadForm = () => {
            const form = document.getElementById('upload-form');
            form.style.display = form.style.display === "block" ? "none" : "block";
        };

        // Cloudinary Trigger
        window.triggerCloudinary = () => {
            cloudinary.openUploadWidget({ 
                cloudName: "dcsczlahu", 
                uploadPreset: "ml_default", 
                resourceType: 'video' 
            }, (err, res) => {
                if (!err && res.event === "success") {
                    tempUploadUrl = res.info.secure_url;
                    document.getElementById('upload-status').style.display = "block";
                    document.getElementById('final-upload-btn').style.display = "block";
                }
            });
        };

        // Save Data to Firebase
        window.saveSongData = () => {
            const name = document.getElementById('song-name').value;
            const artist = document.getElementById('singer-name').value;
            const logo = document.getElementById('song-logo').value || 'songlogo.jpg';
            
            if(!name || !artist || !tempUploadUrl) return alert("Fill all details & select file!");

            push(ref(rtdb, 'songs'), {
                title: name, artist: artist, logo: logo, url: tempUploadUrl,
                uploader: auth.currentUser.displayName, views: 0, likes: {}
            }).then(() => {
                alert("Published Successfully!");
                location.reload();
            });
        };

        function loadSongs() {
            onValue(ref(rtdb, 'songs'), (snap) => {
                const list = document.getElementById('track-list');
                list.innerHTML = "";
                snap.forEach((child) => {
                    const song = child.val();
                    const songId = child.key;
                    const likesCount = song.likes ? Object.keys(song.likes).length : 0;
                    const isLiked = song.likes && song.likes[auth.currentUser.uid];

                    const item = document.createElement('div');
                    item.className = 'track-item';
                    item.innerHTML = `
                        <img src="${song.logo}" onerror="this.src='songlogo.jpg'" onclick="playSong('${songId}')">
                        <div style="text-align:left" onclick="playSong('${songId}')">
                            <strong>${song.title}</strong><br>
                            <small>${song.artist}</small>
                            <div class="stats">
                                <span><i class="fas fa-eye"></i> ${song.views || 0}</span>
                                <span class="like-btn ${isLiked?'liked':''}" onclick="event.stopPropagation(); toggleLike('${songId}')">
                                    <i class="fas fa-heart"></i> ${likesCount}
                                </span>
                            </div>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        window.toggleLike = (id) => {
            const uid = auth.currentUser.uid;
            const likeRef = ref(rtdb, `songs/${id}/likes/${uid}`);
            onValue(likeRef, (snap) => {
                if (snap.exists()) set(likeRef, null);
                else set(likeRef, true);
            }, { onlyOnce: true });
        };

        window.playSong = (id) => {
            onValue(ref(rtdb, `songs/${id}`), (snap) => {
                const song = snap.val();
                document.getElementById('player-title').innerText = song.title;
                document.getElementById('player-artist').innerText = song.artist;
                document.getElementById('player-img').src = song.logo;
                const audio = document.getElementById('audio-player');
                audio.src = song.url;
                audio.play();
                runTransaction(ref(rtdb, `songs/${id}/views`), (v) => (v || 0) + 1);
            }, { onlyOnce: true });
        };
    </script>
</body>
</html>
