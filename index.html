<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A ONE MUSIC - Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <style>
        :root { --primary: #007bff; --glass: rgba(255, 255, 255, 0.1); --border: rgba(255, 255, 255, 0.2); --success: #28a745; }
        body { font-family: 'Poppins', sans-serif; background: #0f0f12; color: white; margin: 0; padding: 20px; text-align: center; }
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--border); padding: 20px; border-radius: 15px; max-width: 400px; margin: 0 auto 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; outline: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .fab-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--success); color: white; border: none; font-size: 24px; cursor: pointer; }
        #upload-form { display: none; margin-top: 15px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .box { background: var(--glass); padding: 20px; border-radius: 15px; width: 350px; border: 1px solid var(--border); }
        .track-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .track-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .hidden { display: none; }
        .status-msg { font-size: 0.85em; margin: 5px 0; color: #ffeb3b; }
    </style>
</head>
<body>

    <h1>A ONE MUSIC âœ“</h1>

    <div id="auth-section" class="card">
        <h3>Login / Sign Up</h3>
        <input type="text" id="auth-username" placeholder="Full Name">
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-password" placeholder="Password">
        <button class="btn" onclick="handleAuth()">Continue</button>
    </div>

    <div id="app-content" class="hidden">
        <div class="card" style="display:flex; justify-content: space-between; align-items: center; padding: 10px 20px;">
            <b id="user-welcome"></b>
            <button onclick="logout()" style="background:none; border:none; color:#ff4d4d; cursor:pointer;">Logout</button>
        </div>

        <div style="margin-bottom: 30px;">
            <button class="fab-btn" onclick="toggleUploadForm()"><i class="fas fa-plus"></i></button>
            
            <div id="upload-form" class="card">
                <h4><i class="fas fa-upload"></i> New Song</h4>
                <input type="text" id="song-name" placeholder="Song Name">
                <input type="text" id="singer-name" placeholder="Singer Name">
                
                <button class="btn" style="background: #6c757d;" onclick="pickFile('image')">
                    <i class="fas fa-image"></i> Choose Song Logo
                </button>
                <div id="logo-status" class="status-msg">No logo selected</div>

                <button class="btn" style="background: #6c757d;" onclick="pickFile('video')">
                    <i class="fas fa-file-audio"></i> Choose Music File
                </button>
                <div id="audio-status" class="status-msg">No audio selected</div>

                <hr style="border: 0.5px solid var(--border); margin: 15px 0;">
                
                <button id="publish-btn" class="btn" style="background:var(--success); display: none;" onclick="saveSongData()">
                    Publish Song
                </button>
            </div>
        </div>

        <div class="container">
            <div class="box">
                <h3>Global Playlist ðŸ’¿</h3>
                <div id="track-list"></div>
            </div>

            <div class="box">
                <img id="player-img" src="songlogo.jpg" style="width: 100%; border-radius: 15px; max-height: 250px; object-fit: cover;">
                <h4 id="player-title" style="margin: 15px 0 5px;">Select a song</h4>
                <p id="player-artist" style="color: #bbb; font-size: 0.85em; margin-bottom: 15px;"></p>
                <audio id="audio-player" controls style="width: 100%;"></audio>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAthFMO8zGT5BtiOkh4zkc71jL06LR_F9c",
            authDomain: "a-one-chat-19ad6.firebaseapp.com",
            databaseURL: "https://a-one-chat-19ad6-default-rtdb.firebaseio.com",
            projectId: "a-one-chat-19ad6",
            storageBucket: "a-one-chat-19ad6.firebasestorage.app",
            messagingSenderId: "691783470864",
            appId: "1:691783470864:web:0b119fcddf984af66e5f95"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        let songUrl = "";
        let logoUrl = "songlogo.jpg";

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-username').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(cred.user, { displayName: name });
            } catch (e) {
                signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-welcome').innerText = "Hi, " + user.displayName;
                loadSongs();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        window.toggleUploadForm = () => {
            const form = document.getElementById('upload-form');
            form.style.display = form.style.display === "block" ? "none" : "block";
        };

        // Pick File via Cloudinary
        window.pickFile = (type) => {
            cloudinary.openUploadWidget({ 
                cloudName: "dcsczlahu", 
                uploadPreset: "ml_default", 
                resourceType: type 
            }, (err, res) => {
                if (!err && res.event === "success") {
                    if (type === 'image') {
                        logoUrl = res.info.secure_url;
                        document.getElementById('logo-status').innerText = "âœ… Logo Uploaded";
                    } else {
                        songUrl = res.info.secure_url;
                        document.getElementById('audio-status').innerText = "âœ… Audio Uploaded";
                    }
                    if (songUrl) document.getElementById('publish-btn').style.display = "block";
                }
            });
        };

        window.saveSongData = () => {
            const name = document.getElementById('song-name').value;
            const artist = document.getElementById('singer-name').value;
            if(!name || !artist || !songUrl) return alert("Please fill all details!");

            push(ref(rtdb, 'songs'), {
                title: name, artist: artist, logo: logoUrl, url: songUrl,
                uploader: auth.currentUser.displayName, views: 0, likes: {}
            }).then(() => {
                alert("Song Published!");
                location.reload();
            });
        };

        function loadSongs() {
            onValue(ref(rtdb, 'songs'), (snap) => {
                const list = document.getElementById('track-list');
                list.innerHTML = "";
                snap.forEach((child) => {
                    const song = child.val();
                    const songId = child.key;
                    const lCount = song.likes ? Object.keys(song.likes).length : 0;
                    
                    const item = document.createElement('div');
                    item.className = 'track-item';
                    item.innerHTML = `
                        <img src="${song.logo}" onclick="playSong('${songId}')">
                        <div style="text-align:left" onclick="playSong('${songId}')">
                            <strong>${song.title}</strong><br>
                            <small>${song.artist} | <i class="fas fa-heart"></i> ${lCount}</small>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
        }

        window.playSong = (id) => {
            onValue(ref(rtdb, `songs/${id}`), (snap) => {
                const song = snap.val();
                document.getElementById('player-title').innerText = song.title;
                document.getElementById('player-artist').innerText = song.artist;
                document.getElementById('player-img').src = song.logo;
                const audio = document.getElementById('audio-player');
                audio.src = song.url;
                audio.play();
                runTransaction(ref(rtdb, `songs/${id}/views`), (v) => (v || 0) + 1);
            }, { onlyOnce: true });
        };
    </script>
</body>
</html>
